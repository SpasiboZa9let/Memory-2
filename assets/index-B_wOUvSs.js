import"./index-K-TeprUe.js";function b(i,e=document){return e.querySelector(i)}class v{constructor(e,s,t,o,c){if(this.mapEl=b(e),this.markers=s,this.panel=t,this.progress=o,this.audio=c,this.viewedIds=new Set,!this.mapEl){console.error(`Map container "${e}" not found`);return}this.mapEl.style.position="relative",this._onResize=this._renderMarkers.bind(this),window.addEventListener("resize",this._onResize),this._renderMarkers()}_renderMarkers(){this.mapEl.querySelectorAll(".marker").forEach(t=>t.remove());const{width:e,height:s}=this.mapEl.getBoundingClientRect();this.markers.forEach(t=>{if(t.x<0||t.x>1||t.y<0||t.y>1)return;const o=document.createElement("div");o.className="marker",o.style.left=`${t.x*e}px`,o.style.top=`${t.y*s}px`,o.style.backgroundImage=`url(${t.img})`,o.title=t.title||"",o.addEventListener("click",()=>{var n,l;(n=this.panel)!=null&&n.ready&&this.panel.show(t),this.audio&&this.audio.playClick();const c=t.title||`${t.x}_${t.y}`;this.viewedIds.has(c)||(this.viewedIds.add(c),(l=this.progress)==null||l.markViewed())}),this.mapEl.appendChild(o)})}destroy(){window.removeEventListener("resize",this._onResize)}}class w{constructor(e){this.panel=document.querySelector(e),this.img=this.panel.querySelector("img"),this.caption=this.panel.querySelector(".text"),this.subtitle=this.panel.querySelector("#memory-subtitle"),this.dim=document.getElementById("dim-overlay"),this.ready=!0,this.dim.addEventListener("click",()=>this.hide());let s=null;this.panel.addEventListener("touchstart",t=>{t.touches.length===1&&(s=t.touches[0].clientY)}),this.panel.addEventListener("touchmove",t=>{if(!s||t.touches.length>1)return;t.touches[0].clientY-s<-30&&(t.preventDefault(),this.hide(),s=null)},{passive:!1}),this.panel.addEventListener("touchend",()=>{s=null})}show(e){this.ready&&(!e||!e.img||(this.ready=!1,this.img.src=e.img,this.caption.textContent=e.title||"Без подписи",this.subtitle.textContent=e.subtitle||"",this.subtitle.classList.toggle("show",!!e.subtitle),this.panel.classList.add("show"),this.dim.classList.add("visible"),document.documentElement.classList.add("noscroll"),document.body.classList.add("noscroll"),setTimeout(()=>{this.ready=!0},3e3)))}hide(){this.panel.classList.remove("show"),this.dim.classList.remove("visible"),document.documentElement.classList.remove("noscroll"),document.body.classList.remove("noscroll"),this.img.src="",this.caption.textContent="",this.subtitle.textContent="",this.subtitle.classList.remove("show"),this.ready=!0}}class x{constructor(e,s,t){this.total=e,this.viewed=0,this.bar=document.querySelector(s),this.btn=document.querySelector(t),this.btn&&this.btn.classList.add("hidden"),console.log("Прогрессбар инициализирован")}markViewed(){this.viewed+=1;const e=Math.min(this.viewed/this.total*100,100);this.bar.style.width=`${e}%`,this.viewed>=this.total&&this.btn&&this.btn.classList.remove("hidden")}}const d=[{x:.5,y:.2,img:"photos/1.jpg",title:"Завтрак в кафе",subtitle:"Мудрые слова классика"},{x:.659,y:.271,img:"photos/2.jpg",title:"Поездка на велосипеде",subtitle:"Мое увлечение общением не дало тебе возможности съездить сюда.Прости.Надеюсь, мы исправим это в ближайшее время"},{x:.78,y:.42,img:"photos/3.jpg",title:"Старый мост",subtitle:'Ездили в "Шашлычный дворик"'},{x:.78,y:.58,img:"photos/4.jpg",title:"Берёзовая роща",subtitle:"Пили кофе"},{x:.659,y:.729,img:"photos/5.jpg",title:"Станция",subtitle:"Наблюдали за реставрацией парка.И ты искусно совершал маневры, чтобы припарковаться и выехать"},{x:.5,y:.8,img:"photos/6.jpg",title:"Озеро",subtitle:"Держались за ручки"},{x:.341,y:.729,img:"photos/7.jpg",title:"Скала",subtitle:"Посетили Сквер Победы"},{x:.22,y:.58,img:"photos/8.jpg",title:"Поле",subtitle:"Прогуливались по парку и качались на качелях"},{x:.22,y:.42,img:"photos/9.jpg",title:"Домик у реки",subtitle:"А помнишь, куда выходили окна? Наша машинка. Вечерние выходы с сигаретой в места для курения"},{x:.341,y:.271,img:"photos/10.jpg",title:"Закат",subtitle:"Это был самый вкусный шашлык, потому что был из твоих рук"},{x:.5,y:.5,img:"photos/11.jpg",title:"",subtitle:"Я помню…"}];function f(){const i=Array.from(document.querySelectorAll(".marker"));if(i.length<2)return;const e=document.getElementById("map"),s=e.getBoundingClientRect(),t=i.map(h=>{const r=h.getBoundingClientRect();return{x:r.left+r.width/2-s.left,y:r.top+r.height/2-s.top}}),o=[];o.push(`M ${t[0].x},${t[0].y}`);for(let h=1;h<t.length;h++){const r=t[h-1],u=t[h],m=r.x+(u.x-r.x)/3,p=r.y,g=r.x+2*(u.x-r.x)/3,y=u.y;o.push(`C ${m},${p} ${g},${y} ${u.x},${u.y}`)}const c=document.getElementById("route-svg");c&&c.remove();const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("viewBox",`0 0 ${s.width} ${s.height}`),n.setAttribute("id","route-svg"),n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.zIndex="2",n.style.pointerEvents="none";const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d",o.join(" ")),l.setAttribute("fill","none"),l.setAttribute("stroke","#888"),l.setAttribute("stroke-width","2"),l.setAttribute("stroke-linecap","round"),l.setAttribute("stroke-dasharray","4 4"),n.appendChild(l),e.appendChild(n)}class E{constructor(){this.music=new Audio("audio/bg.mp3"),this.music.loop=!0,this.music.volume=.4,this.click=new Audio("audio/click.mp3"),this.click.volume=.6,this.initiated=!1}initOnce(){this.initiated||(this.music.play().catch(()=>{}),this.initiated=!0)}playClick(){this.click.currentTime=0,this.click.play().catch(()=>{})}toggleMusic(){this.music.paused?this.music.play():this.music.pause()}}class L{constructor(e,s){this.imageEl=document.querySelector(e),this.photos=s,this.current=0,this.prevBtn=document.querySelector("#prev-photo"),this.nextBtn=document.querySelector("#next-photo"),this.closeBtn=document.querySelector("#album-close"),this.modal=document.querySelector("#album-modal"),this._bind(),this._render()}_bind(){this.prevBtn.addEventListener("click",()=>this._prev()),this.nextBtn.addEventListener("click",()=>this._next()),this.closeBtn.addEventListener("click",()=>this.hide())}_render(){this.imageEl.src=this.photos[this.current],this.imageEl.alt=`Фото ${this.current+1}`}_prev(){this.current=(this.current-1+this.photos.length)%this.photos.length,this._render()}_next(){this.current=(this.current+1)%this.photos.length,this._render()}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}}const a=new E;document.body.classList.add("no-scroll");j();function j(){const i=document.getElementById("start-button"),e=document.getElementById("start-screen");i&&e?i.addEventListener("click",()=>{e.remove(),document.body.classList.remove("no-scroll"),a.initOnce(),S()}):console.warn("❗ Кнопка или экран старта не найдены")}function S(){const i=new w("#memory-panel"),e=new x(d.length,"#progress-bar","#open-album");new v("#map",d,i,e,a),setTimeout(f,100);const s=new L("#album-image",["album/1.jpg","album/2.jpg","album/3.jpg","album/4.jpg","album/5.jpg","album/6.jpg","album/7.jpg","album/8.jpg","album/9.jpg","album/10.jpg","album/11.jpg"]),t=document.querySelector("#open-album");t&&t.addEventListener("click",()=>s.show())}export{S as initMap};
